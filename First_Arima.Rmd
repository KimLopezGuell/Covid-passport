---
title: "First ARIMA model - Procedure check"
author: "Kim López-Güell"
date: "18/1/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(forecast)
```

This is a "dummy" code created only for Germany cases data, modeled with ARIMA. First, we read and polish the data.

```{r data}
setwd("/home/user/Escritorio/Kim/Oxford/Dissertation/Data")
Cases_EU <- read.csv("Cases_EU_dc16.csv")
Cases_EU <- as_tibble(Cases_EU)
Cases_EU <- Cases_EU[,c(1,5,7)]
Cases_EU <- Cases_EU[Cases_EU$countriesAndTerritories %in% c("Denmark", "France", "Germany"), ]
Cases_EU <- Cases_EU[!grepl("2020", Cases_EU$dateRep),]
Cases_EU <- Cases_EU[!grepl("01/03/2021", Cases_EU$dateRep),]
Cases_EU$dateRep <- as.Date(Cases_EU$dateRep,format="%d/%m/%y")
colnames(Cases_EU)[1] <- "date"
Cases_EU_region <- split(Cases_EU, Cases_EU$countriesAndTerritories)
De_cases <- Cases_EU_region[[3]]
n <- nrow(De_cases)
De_cases$cases <- rev(De_cases$cases)
De_cases$date <- rev(De_cases$date)
```

We select the first intervention time range, equal to the one used in the SR analyses. We look at its plot and ACF, PACF plots as well.

```{r NP1}

De_cases_NP1 <- De_cases[c(122:189),]
ggplot(data = De_cases_NP1, aes(x = date, y = cases)) +  geom_line() +  labs(title = "Cases in Germany", x = "Date", y = "Cases")
par(mfrow=c(1,2))
acf(De_cases_NP1$cases)
pacf(De_cases_NP1$cases)

```

A seasonal 7-day ARIMA model might seem intuitive, but the plots don't show that. Like, the 7-lag, for instance, is not significant at all. It is therefore not introduced. The ACF plot has positive correlation until lag 15. We will differentiate once.

```{r diff}

cases_dif <- c(NA,diff(De_cases_NP1$cases,lag=1))
De_cases_NP1 <- cbind(De_cases_NP1,cases_dif)
ggplot(data = De_cases_NP1, aes(x = date, y = cases_dif)) +  geom_line() +  labs(title = "Cases in Germany", x = "Date", y = "Cases")
par(mfrow=c(1,2))
acf(De_cases_NP1$cases_dif[-1])
pacf(De_cases_NP1$cases_dif[-1])

```

No further differentiation seems necessary, looking at ACF. As for AR or MA terms, the plots seem to indicate that p=3 or q=3 might be good. Let's check with different models. First, though, we define the three vectors (NPI and two tendencies).

```{r matrix}

NPI1 <- c(rep(0,174),rep(NA,5),rep(1,(n-179)))
t1 <- c(c(0:173),rep(NA,5),c(174:(n-6)))
t2 <- c(rep(0,174),rep(NA,5),c(0:(n-180)))
matriu1 <- cbind(NPI1,t1,t2)
matriuNP1 <- matriu1[c(122:189),]

```

We run auto.arima models with and without differentiation of the data, and then our own arima selected models with different parameters. **Should other models be tried as well, with other p and q? Like 1 just to check, or 4 or 5?**

```{r fit}

autoarima_0 <- auto.arima(y=De_cases_NP1$cases,seasonal=T,xreg=matriuNP1)
autoarima_1 <- auto.arima(y=De_cases_NP1$cases_dif,seasonal=T,xreg=matriuNP1)
arima_013 <- Arima(y=De_cases_NP1$cases_dif,order=c(0,0,3),xreg=matriuNP1)
arima_310 <- Arima(y=De_cases_NP1$cases_dif,order=c(3,0,0),xreg=matriuNP1)
arima_313 <- Arima(y=De_cases_NP1$cases_dif,order=c(3,0,3),xreg=matriuNP1)

```

Let's finish by comparing coefficients, AIC and residuals of all models. 

```{r models}
autoarima_0
checkresiduals(autoarima_0)

autoarima_1
checkresiduals(autoarima_1)

arima_013
checkresiduals(arima_013)

arima_310
checkresiduals(arima_310)

arima_313
checkresiduals(arima_313)
```

There is more than one thing to comment. Firstly, what is auto.arima doing? In principle it should select the best model in terms of AIC/BIC, yet its choices are worse than the ones we try afterwards. Oh, well.

If we only look at AIC/BIC we would be left with the (3,1,3) model. Yet the difference is so minimal that it probably is not very determinant as a factor of choice between one or the other. They are all also quite similar in terms of correlation - nothing too dramatic, but residual correlation in all of them. It does seem to be interesting to differentiate, as it makes the error in t2 small enough so that its whole interval is negative.

I am therefore unsure as to which would be the best for us. **What do you do in these situations?** It might not be very important in this case, because either one of them shows what we want, but in case I encounter an example in which the change leads me to choose between a model that "I like" and one that "I don't like", I want to choose as a statistitian and not as a cheater.

Also, maybe this is not relevant, but apart from the fact that the residuals are generally not perfect in terms of correlation (yet some are decent), they do present quite a striking heteroscedasticity. We could correct this with a Box-Cox transformation. **Yet, to what point is it significant here, for our purposes?** Anyway, we will do it with all the models from before.

```{r modelsBC}
lambda <- BoxCox.lambda(De_cases_NP1$cases_dif)
lambda
cases_dif_BC <- BoxCox(cases_dif,lambda)
De_cases_NP1 <- cbind(De_cases_NP1,cases_dif_BC)

autoarima_1b <- auto.arima(y=De_cases_NP1$cases_dif_BC,seasonal=T,xreg=matriuNP1)
arima_013b <- Arima(y=De_cases_NP1$cases_dif_BC,order=c(0,0,3),xreg=matriuNP1)
arima_310b <- Arima(y=De_cases_NP1$cases_dif_BC,order=c(3,0,0),xreg=matriuNP1)
arima_313b <- Arima(y=De_cases_NP1$cases_dif_BC,order=c(3,0,3),xreg=matriuNP1)

autoarima_1b
checkresiduals(autoarima_1b)

arima_013b
checkresiduals(arima_013b)

arima_310b
checkresiduals(arima_310b)

arima_313b
checkresiduals(arima_313b)
```

So the best one is still (3,1,3) in terms of AIC/BIC, but if we selected the (0,1,1) or (0,1,3) we would have a slightly worse AIC/BIC but much better correlation plots. **What would be better, in your opinion?**

Also, in general all these models have a huge improvement in terms of correlation and variance, and an obvious lower AIC/BIC, but now the error terms of the t2 coefficient are relatively bigger. **Is this an improvement, or should we stick to the previous models, without Box-Cox?**

Thank you!
